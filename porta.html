<!-- REEMPLAZAR el contenido de estos dos tamiz-item en tu HTML -->

<!-- Atresia de v√≠as biliares - LAYOUT CORREGIDO -->
<div class="tamiz-item">
    <div class="tamiz-header">
        <input type="checkbox" id="atresia-biliares" name="enfermedades[]"
            value="atresia-biliares" class="tamiz-checkbox">
        <label for="atresia-biliares" class="tamiz-label">üíõ Atresia de v√≠as biliares</label>
    </div>
    <div class="tamiz-details" id="details_atresia-biliares">
        <div class="atresia-container">
            <div class="registros-atresia" id="registros_atresia">
                <div class="form-row-horizontal">
                    <div class="form-group-fecha">
                        <label class="form-label">Fecha de detecci√≥n:</label>
                        <input type="date" name="fecha_atresia[]"
                            class="form-input fecha-atresia" required>
                        <small class="error-message"
                            style="color: #e74c3c; font-size: 12px; display: none;"></small>
                    </div>
                    
                    <div class="form-group-resultado">
                        <label class="form-label">Resultado:</label>
                        <div class="radio-group-horizontal">
                            <div class="radio-item">
                                <input type="radio" id="atresianormal" name="tipoatresia"
                                    value="normal" class="radio-input" required>
                                <label for="atresianormal" class="radio-label">Normal</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="atresiaanormal" name="tipoatresia"
                                    value="anormal" class="radio-input" required>
                                <label for="atresiaanormal" class="radio-label">Anormal</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detecci√≥n de defectos de agudeza visual - LAYOUT CORREGIDO -->
<div class="tamiz-item">
    <div class="tamiz-header">
        <input type="checkbox" id="agudeza_visual" name="enfermedades[]"
            value="agudeza_visual" class="tamiz-checkbox">
        <label for="agudeza_visual" class="tamiz-label">üëÅÔ∏è Detecci√≥n de defectos de agudeza
            visual (4 a 6 a√±os)</label>
    </div>
    <div class="tamiz-details" id="details_agudeza_visual">
        <div class="agudeza-visual-container">
            <div class="registros-agudeza" id="registros_agudeza">
                <!-- Los registros se crear√°n din√°micamente con JavaScript -->
            </div>
            <button type="button" class="btn-add-registro" onclick="agregarRegistroAgudeza()">
                ‚ûï Agregar Registro
            </button>
        </div>
    </div>
</div>


/* CSS PARA LAYOUT MEJORADO DE DETECCI√ìN */
/* AGREGAR AL FINAL DEL <style> EXISTENTE, ANTES DE </style> */

/* Layout horizontal para atresia de v√≠as biliares */
.form-row-horizontal {
    display: flex;
    align-items: end;
    gap: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    margin-bottom: 10px;
}

.form-group-fecha {
    flex: 1;
    min-width: 200px;
}

.form-group-resultado {
    flex: 2;
    min-width: 250px;
}

.form-group-fecha .form-label,
.form-group-resultado .form-label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group-fecha .form-input {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    font-size: 13px;
    transition: all 0.3s ease;
}

.form-group-fecha .form-input:focus {
    outline: none;
    border-color: #27ae60;
    box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
}

/* Radio buttons horizontales */
.radio-group-horizontal {
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.radio-group-horizontal .radio-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 12px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 20px;
    transition: all 0.3s ease;
    min-width: 100px;
    justify-content: center;
}

.radio-group-horizontal .radio-item:hover {
    border-color: #27ae60;
    background: #f0f8f0;
    transform: translateY(-1px);
}

.radio-group-horizontal .radio-item input[type="radio"]:checked + .radio-label {
    color: #27ae60;
    font-weight: 600;
}

.radio-group-horizontal .radio-item:has(input[type="radio"]:checked) {
    border-color: #27ae60;
    background: #d4edda;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.2);
}

/* Estilos para los registros de agudeza visual */
.registro-agudeza-horizontal {
    display: flex;
    align-items: end;
    gap: 20px;
    padding: 15px;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    position: relative;
    transition: all 0.3s ease;
}

.registro-agudeza-horizontal:hover {
    border-color: #3498db;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
}

.registro-fecha-grupo {
    flex: 1;
    min-width: 180px;
}

.registro-resultado-grupo {
    flex: 2;
    min-width: 250px;
}

.registro-acciones-grupo {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
}

.btn-eliminar-registro {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-eliminar-registro:hover {
    background: #c0392b;
    transform: scale(1.1);
}

/* Bot√≥n para agregar registro */
.btn-add-registro {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    margin-top: 15px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-add-registro:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
}

/* Animaci√≥n para nuevos registros */
@keyframes slideInRegistro {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.registro-agudeza-horizontal {
    animation: slideInRegistro 0.3s ease-out;
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .form-row-horizontal,
    .registro-agudeza-horizontal {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .form-group-fecha,
    .form-group-resultado,
    .registro-fecha-grupo,
    .registro-resultado-grupo {
        min-width: auto;
        flex: none;
    }
    
    .radio-group-horizontal {
        justify-content: space-between;
    }
    
    .radio-group-horizontal .radio-item {
        flex: 1;
        min-width: auto;
    }
    
    .registro-acciones-grupo {
        justify-content: center;
        margin-top: 10px;
    }
}

/* Mejorar la apariencia de los contenedores principales */
.atresia-container,
.agudeza-visual-container {
    padding: 10px;
}

/* Estados de validaci√≥n */
.form-input.error {
    border-color: #e74c3c;
    background: #fdf2f2;
}

.form-input.success {
    border-color: #27ae60;
    background: #f0f8f0;
}

/* Indicador de registro obligatorio */
.form-row-horizontal::before {
    content: "üìù";
    position: absolute;
    top: -10px;
    left: 10px;
    background: white;
    padding: 0 5px;
    font-size: 12px;
}




// JAVASCRIPT PARA LAYOUT MEJORADO DE DETECCI√ìN
// AGREGAR/REEMPLAZAR estas funciones en tu c√≥digo existente

// Funci√≥n mejorada para crear un nuevo registro de agudeza visual
function crearRegistroAgudeza() {
    contadorRegistrosAgudeza++;
    const registroId = `registro_agudeza_${contadorRegistrosAgudeza}`;

    const registroDiv = document.createElement('div');
    registroDiv.className = 'registro-agudeza-horizontal';
    registroDiv.id = registroId;

    registroDiv.innerHTML = `
        <div class="registro-fecha-grupo">
            <label class="form-label">Fecha de detecci√≥n:</label>
            <input type="date" name="fecha_agudeza_visual[]" 
                   class="form-input fecha-agudeza" 
                   data-registro="${registroId}" required>
            <small class="error-message" style="color: #e74c3c; font-size: 12px; display: none;"></small>
        </div>

        <div class="registro-resultado-grupo">
            <label class="form-label">Resultado:</label>
            <div class="radio-group-horizontal">
                <div class="radio-item">
                    <input type="radio" id="normal_${registroId}" name="resultado_${registroId}"
                           value="normal" class="radio-input" required>
                    <label for="normal_${registroId}" class="radio-label">Normal</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="anormal_${registroId}" name="resultado_${registroId}"
                           value="anormal" class="radio-input" required>
                    <label for="anormal_${registroId}" class="radio-label">Anormal</label>
                </div>
            </div>
        </div>

        <div class="registro-acciones-grupo">
            <button type="button" class="btn-eliminar-registro" 
                    onclick="eliminarRegistroAgudeza('${registroId}')" 
                    title="Eliminar registro">
                üóëÔ∏è
            </button>
        </div>
    `;

    return registroDiv;
}

// Funci√≥n para agregar un nuevo registro de agudeza visual
function agregarRegistroAgudeza() {
    const registrosContainer = document.getElementById('registros_agudeza');
    const nuevoRegistro = crearRegistroAgudeza();
    registrosContainer.appendChild(nuevoRegistro);

    // Agregar validaci√≥n a la nueva fecha
    const fechaInput = nuevoRegistro.querySelector('.fecha-agudeza');
    fechaInput.addEventListener('change', function() {
        const validacion = validarFechaAgudeza(this.value);
        const errorMessage = this.parentNode.querySelector('.error-message');

        if (!validacion.valida) {
            this.classList.add('error');
            this.classList.remove('success');
            errorMessage.textContent = validacion.mensaje;
            errorMessage.style.display = 'block';
            this.value = ''; // Limpiar el campo
        } else {
            this.classList.remove('error');
            this.classList.add('success');
            errorMessage.style.display = 'none';
        }
    });

    // Agregar listeners para los radio buttons
    const radioInputs = nuevoRegistro.querySelectorAll('.radio-input');
    radioInputs.forEach(radio => {
        radio.addEventListener('change', function() {
            // Remover clase selected de todos los radio items del mismo grupo
            const grupoNombre = this.name;
            const grupoItems = nuevoRegistro.querySelectorAll(`input[name="${grupoNombre}"]`);
            grupoItems.forEach(grupoRadio => {
                const parentItem = grupoRadio.closest('.radio-item');
                if (parentItem) {
                    parentItem.classList.remove('selected');
                }
            });
            
            // Agregar clase selected al item actual
            const parentItem = this.closest('.radio-item');
            if (parentItem) {
                parentItem.classList.add('selected');
            }
        });
    });

    // Hacer scroll al nuevo elemento
    nuevoRegistro.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Funci√≥n mejorada para validar fechas de agudeza visual
function validarFechaAgudeza(fecha) {
    const fechaIngresada = new Date(fecha);
    const fechaActual = new Date();
    
    // Fecha de nacimiento del paciente (deber√≠as obtenerla del sistema real)
    const fechaNacimientoPaciente = new Date('2018-01-01'); // Ejemplo

    // No permitir fechas futuras
    if (fechaIngresada > fechaActual) {
        return { 
            valida: false, 
            mensaje: 'No se permite registrar una fecha mayor a la actual' 
        };
    }

    // No permitir fechas menores a la fecha de nacimiento
    if (fechaIngresada < fechaNacimientoPaciente) {
        return { 
            valida: false, 
            mensaje: 'No se permite registrar una fecha menor a la fecha de nacimiento del paciente' 
        };
    }

    // Validar que el ni√±o tenga entre 4 y 6 a√±os en la fecha de detecci√≥n
    const edadEnMeses = (fechaIngresada - fechaNacimientoPaciente) / (1000 * 60 * 60 * 24 * 30.44);
    if (edadEnMeses < 48 || edadEnMeses > 72) { // 4 a√±os = 48 meses, 6 a√±os = 72 meses
        return {
            valida: false,
            mensaje: 'La detecci√≥n de agudeza visual debe realizarse entre los 4 y 6 a√±os de edad'
        };
    }

    return { valida: true, mensaje: '' };
}

// Funci√≥n mejorada para eliminar un registro de agudeza visual
window.eliminarRegistroAgudeza = function(registroId) {
    if (confirm('¬øEst√° seguro de eliminar este registro?')) {
        const registro = document.getElementById(registroId);
        if (registro) {
            // Animaci√≥n de salida
            registro.style.transform = 'translateX(-100%)';
            registro.style.opacity = '0';
            
            setTimeout(() => {
                registro.remove();
            }, 300);
        }

        // Si no quedan registros, ocultar la secci√≥n
        setTimeout(() => {
            const registrosContainer = document.getElementById('registros_agudeza');
            if (registrosContainer.children.length === 0) {
                const checkbox = document.getElementById('agudeza_visual');
                checkbox.checked = false;
                toggleTamizDetails(checkbox);
            }
        }, 350);
    }
};

// Funci√≥n mejorada para toggle de detalles (actualizar la existente)
function toggleTamizDetails(checkbox) {
    const detailsId = 'details_' + checkbox.id;
    const detailsDiv = document.getElementById(detailsId);

    if (detailsDiv) {
        if (checkbox.checked) {
            detailsDiv.classList.add('active', 'show');

            // Si es agudeza visual y no hay registros, crear el primero autom√°ticamente
            if (checkbox.id === 'agudeza_visual') {
                const registrosContainer = document.getElementById('registros_agudeza');
                if (registrosContainer.children.length === 0) {
                    agregarRegistroAgudeza();
                }
            }
        } else {
            detailsDiv.classList.remove('active', 'show');
            
            // Limpiar los campos cuando se desmarca
            if (checkbox.id === 'agudeza_visual') {
                // Limpiar todos los registros de agudeza visual
                const registrosContainer = document.getElementById('registros_agudeza');
                registrosContainer.innerHTML = '';
                contadorRegistrosAgudeza = 0;
            } else {
                const inputs = detailsDiv.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    if (input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        }
    }
}

// Mejorar la funci√≥n de guardado para incluir los nuevos datos
function obtenerDatosDeteccion() {
    const datos = {};
    
    // Obtener datos de atresia de v√≠as biliares
    const atresiaCheckbox = document.getElementById('atresia-biliares');
    if (atresiaCheckbox && atresiaCheckbox.checked) {
        const fechaAtresia = document.querySelector('input[name="fecha_atresia[]"]');
        const resultadoAtresia = document.querySelector('input[name="tipoatresia"]:checked');
        
        datos.atresia_vias_biliares = {
            fecha: fechaAtresia ? fechaAtresia.value : '',
            resultado: resultadoAtresia ? resultadoAtresia.value : ''
        };
    }
    
    // Obtener datos de agudeza visual
    const agudezaCheckbox = document.getElementById('agudeza_visual');
    if (agudezaCheckbox && agudezaCheckbox.checked) {
        const registros = [];
        const registrosElements = document.querySelectorAll('.registro-agudeza-horizontal');
        
        registrosElements.forEach(registro => {
            const fechaInput = registro.querySelector('.fecha-agudeza');
            const resultadoRadio = registro.querySelector('input[type="radio"]:checked');
            
            if (fechaInput && fechaInput.value && resultadoRadio) {
                registros.push({
                    fecha: fechaInput.value,
                    resultado: resultadoRadio.value
                });
            }
        });
        
        datos.agudeza_visual = registros;
    }
    
    return datos;
}

// Event listeners adicionales para el nuevo layout
document.addEventListener('DOMContentLoaded', function() {
    // Agregar listeners para radio buttons de atresia
    document.addEventListener('change', function(e) {
        if (e.target.matches('input[name="tipoatresia"]')) {
            // Remover clase selected de todos los radio items del grupo
            const grupoItems = document.querySelectorAll('input[name="tipoatresia"]');
            grupoItems.forEach(radio => {
                const parentItem = radio.closest('.radio-item');
                if (parentItem) {
                    parentItem.classList.remove('selected');
                }
            });
            
            // Agregar clase selected al item actual
            const parentItem = e.target.closest('.radio-item');
            if (parentItem) {
                parentItem.classList.add('selected');
            }
        }
    });
});